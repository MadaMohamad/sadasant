(function(e,t,i){var n=i.find("#filter"),a=i.find("li",n),s=a[0].cloneNode(true),r=a.shift(),l=i.find("input",r),f=i.find("#trunk"),o={},c=[],h,d,u,p,v,g,C=0,m="active";a.map(function(e){e.onclick=S;e.firstChild.onclick=w});y();k();i.addEvent(e,"popstate",L);i.addEvent(l,"keyup",T);i.addEvent(e,"scroll",_);function y(){if(!history.replaceState){return}var t=i.find(".article",f),n=i.find(".headline",f),s,r=[],l,o=0;for(;s=a[o++];){if(i.hasClass(s,m)){r[r.length]=s.firstChild.innerHTML}}o=0;l={posts:[],className:t.length?"article":"headline",active_tags:r};if(!t.length){t=n}for(;t[o];o++){l.posts[o]=t[o].innerHTML}history.replaceState(l,"",e.location.pathname+e.location.search)}function T(){if(p===l.value){return}p=l.value;p=p.replace(/[^\w ]/g,"").toLowerCase();l.value=p;var e,t=0,s;if(p.length<3){if(h){for(s in o){if(!i.hasClass(o[s],m)){n.removeChild(o[s]);delete o[s]}}}if(p){return}}else if(!h){h=true;for(;e=a[t++];){if(!i.hasClass(e,m)){n.removeChild(e)}else{o[e.firstChild.innerHTML]=e}}a.length=0}if(!d){d=true;N(p)}}function N(e){e=e?"/?tags="+e:"/json/top_tags.json";i.http("GET",e,function(e,t){var a,r,l,f=0;if(e){a=JSON.parse(t);if(a.length){for(r in o){if(!i.hasClass(o[r],m)&&!~a.indexOf(r)){n.removeChild(o[r]);delete o[r]}}for(;r=a[f++];){if(!o[r]){l=s.cloneNode(true);l.innerHTML='<a href="/?filter='+r+'">'+r+"</a>";l.onclick=S;l.firstChild.onclick=w;o[r]=l;n.appendChild(l)}}}d=false}})}function S(){if(i.hasClass(this,m)){i.removeClass(this,m)}else{i.addClass(this,m)}E()}function w(e){e.preventDefault()}function E(){if(u){return}u=true;var e=n.getElementsByClassName(m),t,a=0,s="",r;if(!e.length){u=false;return}f.style.opacity=.3;for(;t=e[a++];){s+=t.firstChild.innerHTML+" "}c=s;r="/?filter="+s;if(!history.pushState){window.location=r}i.http("GET",r+"&json=1",H)}function H(e,t){if(e){t=JSON.parse(t);t.active_tags=c;t.className="article";history.pushState(t,"","/?filter="+c);history.forward();L({state:t})}else{f.style.opacity=1}u=false}function L(e){g=false;C=0;var t=e?e.state:history.state,n=0,s,r;if(!t){return}f.innerHTML="";if(t.active_tags){c=t.active_tags;for(;s=a[n++];){r=s.firstChild.innerHTML;if(~c.indexOf(r)){if(!i.hasClass(s,m)){i.addClass(s,m)}}else{if(i.hasClass(s,m)){i.removeClass(s,m)}}}M()}O(t.posts,t.className)}function M(){var e=[],t=r.parentNode,n,a=r,s=0;while(a=a.nextSibling){if(a.tagName==="LI"){if(i.hasClass(a,m)){e[e.length]=a}else{if(!n){n=a}}}}for(;a=e[s++];){t.insertBefore(a,n)}}function O(e,n){var a=0,s,r;if(!e.length){return}if(e.length===1){e=[e]}l();function l(){if(s=e[a++]){r=t.createElement("div");i.addClass(r,n);r.innerHTML=s;f.appendChild(r);setTimeout(l,100)}else{k();f.style.opacity=1}}}function k(){if(!history.pushState){return}var e=i.find("h1 a",f),t,n=0;if(!e){return}for(;t=e[n++];){t.onclick=j}}function j(e){e.preventDefault();var t=this.href;f.style.opacity=.3;i.http("GET",t+"?json=1",function(e,i){if(e){i=JSON.parse(i);i.className="article";history.pushState(i,"",t);history.forward();L({state:i})}})}function _(){if(g){return}var n=e.location.pathname;if(!(n&&!~n.indexOf(".html"))){return}var a=t.documentElement.clientHeight?t.documentElement:t.body,s=e.scrollY||e.pageYOffset||a.scrollTop,r=n==="/"?"article":"headline",l;if(v===s){return}v=s;if(a.scrollHeight===s+a.clientHeight){l=n+(e.location.search||"?");l=l.split("&")[0]+"&json=1&page="+(C+1);i.http("GET",l,function(e,t){if(e&&t){C+=1;t=JSON.parse(t);if(!t.posts.length){g=true;return}O(t.posts,r)}})}}})(window,document,window.Shade);