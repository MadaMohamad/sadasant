// site.js
// by Daniel Rodr√≠guez
// http://sadasant.com/license
(function(e,t,n){function y(){if(!history.replaceState)return;var t=n.find(".article",a),r=n.find(".headline",a),s,o=[],u,f=0;for(;s=i[f++];)n.hasClass("active",s)&&(o[o.length]=s.firstChild.innerHTML);f=0,u={posts:[],className:t.length?"article":"headline",active_tags:o},t.length||(t=r);for(;t[f];f++)u.posts[f]=t[f].innerHTML;history.replaceState(u,"",e.location.pathname+e.location.search)}function b(){d=u.value,d=d.replace(/[^\w ]/g,"").toLowerCase(),u.value=d;var e,t=0,s;if(d.length<3){if(c)for(s in f)n.hasClass("active",f[s])||(r.removeChild(f[s]),delete f[s]);return}if(!c){c=!0;for(;e=i[t++];)n.hasClass("active",e)?f[e.firstChild.innerHTML]=e:r.removeChild(e);i.length=0}h||(h=!0,w(d))}function w(e){n.http("GET","/?tags="+e,function(e,t){var i,o,u,a=0;if(e){i=JSON.parse(t);if(i.length){for(o in f)!n.hasClass("active",f[o])&&!~i.indexOf(o)&&(r.removeChild(f[o]),delete f[o]);for(;o=i[a++];)f[o]||(u=s.cloneNode(!0),u.innerHTML='<a href="/?filter='+o+'">'+o+"</a>",u.onclick=E,u.firstChild.onclick=S,f[o]=u,r.appendChild(u))}h=!1}})}function E(){n.hasClass("active",this)?n.removeClass("active",this):n.addClass("active",this),a.style.opacity=.3,setTimeout(x,1e3)}function S(e){e.preventDefault()}function x(){if(p)return;p=!0;var e=r.getElementsByClassName("active"),t,i=0,s="",o;if(!e.length){p=!1;return}for(;t=e[i++];)s+=t.firstChild.innerHTML+" ";l=s,o="/?filter="+s,history.pushState||(window.location=o),n.http("GET",o+"&json=1",T)}function T(e,t){e?(t=JSON.parse(t),t.active_tags=l,t.className="article",history.pushState(t,"","/?filter="+l),history.forward(),N({state:t})):a.style.opacity=1,p=!1}function N(e){m=!1,g=0;var t=e?e.state:history.state,r=0,s,o;if(!t)return;a.innerHTML="";if(t.active_tags){l=t.active_tags;for(;s=i[r++];)o=s.firstChild.innerHTML,~l.indexOf(o)?n.addClass("active",s):n.removeClass("active",s)}C(t.posts,t.className)}function C(e,r){function u(){(s=e[i++])?(o=t.createElement("div"),n.addClass(r,o),o.innerHTML=s,a.appendChild(o),setTimeout(u,100)):(k(),a.style.opacity=1)}var i=0,s,o;if(!e.length)return;e.length===1&&(e=[e]),u()}function k(){if(!history.pushState)return;var e=n.find("h1 a",a),t,r=0;if(!e)return;for(;t=e[r++];)t.onclick=L}function L(e){e.preventDefault();var t=this.href;a.style.opacity=.3,n.http("GET",t+"?json=1",function(e,n){e&&(n=JSON.parse(n),n.className="article",history.pushState(n,"",t),history.forward(),N({state:n}))})}function A(){if(m)return;var r=e.location.pathname;if(!r||!!~r.indexOf(".html"))return;var i=t.documentElement.clientHeight?t.documentElement:t.body,s=e.scrollY||e.pageYOffset||i.scrollTop,o=r==="/"?"article":"headline",u;if(v===s)return;v=s,i.scrollHeight===s+i.clientHeight&&(u=r+(e.location.search||"?"),u=u.split("&")[0]+"&json=1&page="+(g+1),n.http("GET",u,function(e,t){if(e&&t){g+=1,t=JSON.parse(t);if(!t.posts.length){m=!0;return}C(t.posts,o)}}))}var r=n.find("#filter"),i=n.find("li",r),s=i[0].cloneNode(!0),o=i.shift(),u=n.find("input",o),a=n.find("#trunk"),f={},l,c,h,p,d,v,m,g=0;i.map(function(e){e.onclick=E,e.firstChild.onclick=S}),y(),k(),n.addEvent(e,"popstate",N),n.addEvent(u,"keyup",b),n.addEvent(e,"scroll",A)})(window,document,window.Shade);