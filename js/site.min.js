// site.js
// by Daniel Rodr√≠guez
// http://sadasant.com/license
(function(e,t,n){function b(){if(!history.replaceState)return;var t=n.find(".article",a),r=n.find(".headline",a),s,o=[],u,f=0;for(;s=i[f++];)n.hasClass(y,s)&&(o[o.length]=s.firstChild.innerHTML);f=0,u={posts:[],className:t.length?"article":"headline",active_tags:o},t.length||(t=r);for(;t[f];f++)u.posts[f]=t[f].innerHTML;history.replaceState(u,"",e.location.pathname+e.location.search)}function w(){if(d===u.value)return;d=u.value,d=d.replace(/[^\w ]/g,"").toLowerCase(),u.value=d;var e,t=0,s;if(d.length<3){if(c)for(s in f)n.hasClass(y,f[s])||(r.removeChild(f[s]),delete f[s]);if(d)return}else if(!c){c=!0;for(;e=i[t++];)n.hasClass(y,e)?f[e.firstChild.innerHTML]=e:r.removeChild(e);i.length=0}h||(h=!0,E(d))}function E(e){e=e?"/?tags="+e:"/json/top_tags.json",n.http("GET",e,function(e,t){var i,o,u,a=0;if(e){i=JSON.parse(t);if(i.length){for(o in f)!n.hasClass(y,f[o])&&!~i.indexOf(o)&&(r.removeChild(f[o]),delete f[o]);for(;o=i[a++];)f[o]||(u=s.cloneNode(!0),u.innerHTML='<a href="/?filter='+o+'">'+o+"</a>",u.onclick=S,u.firstChild.onclick=x,f[o]=u,r.appendChild(u))}h=!1}})}function S(){n.hasClass(y,this)?n.removeClass(y,this):n.addClass(y,this),T()}function x(e){e.preventDefault()}function T(){if(p)return;p=!0;var e=r.getElementsByClassName(y),t,i=0,s="",o;if(!e.length){p=!1;return}a.style.opacity=.3;for(;t=e[i++];)s+=t.firstChild.innerHTML+" ";l=s,o="/?filter="+s,history.pushState||(window.location=o),n.http("GET",o+"&json=1",N)}function N(e,t){e?(t=JSON.parse(t),t.active_tags=l,t.className="article",history.pushState(t,"","/?filter="+l),history.forward(),C({state:t})):a.style.opacity=1,p=!1}function C(e){m=!1,g=0;var t=e?e.state:history.state,r=0,s,o;if(!t)return;a.innerHTML="";if(t.active_tags){l=t.active_tags;for(;s=i[r++];)o=s.firstChild.innerHTML,~l.indexOf(o)?n.hasClass(y,s)||n.addClass(y,s):n.hasClass(y,s)&&n.removeClass(y,s);k()}L(t.posts,t.className)}function k(){var e=[],t=o.parentNode,r,i=o,s=0;while(i=i.nextSibling)i.tagName==="LI"&&(n.hasClass(y,i)?e[e.length]=i:r||(r=i));for(;i=e[s++];)t.insertBefore(i,r)}function L(e,r){function u(){(s=e[i++])?(o=t.createElement("div"),n.addClass(r,o),o.innerHTML=s,a.appendChild(o),setTimeout(u,100)):(A(),a.style.opacity=1)}var i=0,s,o;if(!e.length)return;e.length===1&&(e=[e]),u()}function A(){if(!history.pushState)return;var e=n.find("h1 a",a),t,r=0;if(!e)return;for(;t=e[r++];)t.onclick=O}function O(e){e.preventDefault();var t=this.href;a.style.opacity=.3,n.http("GET",t+"?json=1",function(e,n){e&&(n=JSON.parse(n),n.className="article",history.pushState(n,"",t),history.forward(),C({state:n}))})}function M(){if(m)return;var r=e.location.pathname;if(!r||!!~r.indexOf(".html"))return;var i=t.documentElement.clientHeight?t.documentElement:t.body,s=e.scrollY||e.pageYOffset||i.scrollTop,o=r==="/"?"article":"headline",u;if(v===s)return;v=s,i.scrollHeight===s+i.clientHeight&&(u=r+(e.location.search||"?"),u=u.split("&")[0]+"&json=1&page="+(g+1),n.http("GET",u,function(e,t){if(e&&t){g+=1,t=JSON.parse(t);if(!t.posts.length){m=!0;return}L(t.posts,o)}}))}var r=n.find("#filter"),i=n.find("li",r),s=i[0].cloneNode(!0),o=i.shift(),u=n.find("input",o),a=n.find("#trunk"),f={},l=[],c,h,p,d,v,m,g=0,y="active";i.map(function(e){e.onclick=S,e.firstChild.onclick=x}),b(),A(),n.addEvent(e,"popstate",C),n.addEvent(u,"keyup",w),n.addEvent(e,"scroll",M)})(window,document,window.Shade);